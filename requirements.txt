# requirements.txt
flask==2.3.3
flask-cors==4.0.0
requests==2.31.0
python-dotenv==1.0.0
gunicorn==21.2.0
sqlite3

# .env (í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì˜ˆì‹œ)
SECRET_KEY=your-secret-key-here
DATABASE_PATH=/app/data/trading_data.db
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
ADMIN_PASSWORD=your-secure-admin-password
FLASK_ENV=production
PORT=5000

# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY . .

# ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/data

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 5000

# ë¹„ë£¨íŠ¸ ì‚¬ìš©ì ìƒì„±
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# Gunicornìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "2", "--timeout", "120", "production_flask_server:app"]

---
# docker-compose.yml
version: '3.8'

services:
  trading-app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_PATH=/app/data/trading_data.db
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - FLASK_ENV=production
    volumes:
      - trading_data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - trading-app
    restart: unless-stopped

volumes:
  trading_data:

---
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream trading_app {
        server trading-app:5000;
    }

    # HTTP to HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
    server {
        listen 80;
        server_name yourdomain.com www.yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS ì„œë²„
    server {
        listen 443 ssl http2;
        server_name yourdomain.com www.yourdomain.com;

        # SSL ì„¤ì •
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # ë³´ì•ˆ í—¤ë”
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ì •ì  íŒŒì¼
        location /static/ {
            alias /app/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # API í”„ë¡ì‹œ
        location / {
            proxy_pass http://trading_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # íƒ€ì„ì•„ì›ƒ ì„¤ì •
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ë¡œê·¸ ì„¤ì •
        access_log /var/log/nginx/trading_access.log;
        error_log /var/log/nginx/trading_error.log;
    }
}

---
# gunicorn.conf.py
import multiprocessing

# ì„œë²„ ì„¤ì •
bind = "0.0.0.0:5000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 120
keepalive = 2

# ë¡œê¹… ì„¤ì •
accesslog = "/app/logs/gunicorn_access.log"
errorlog = "/app/logs/gunicorn_error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# í”„ë¡œì„¸ìŠ¤ ì„¤ì •
max_requests = 1000
max_requests_jitter = 100
preload_app = True

# ë³´ì•ˆ ì„¤ì •
limit_request_line = 4094
limit_request_fields = 100
limit_request_field_size = 8190

---
# deploy.sh (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸)
#!/bin/bash

echo "ğŸš€ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ë°°í¬ ì‹œì‘"

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
if [ ! -f .env ]; then
    echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.exampleì„ ì°¸ê³ í•˜ì—¬ ìƒì„±í•´ì£¼ì„¸ìš”."
    exit 1
fi

# Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
if ! command -v docker &> /dev/null; then
    echo "âŒ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Composeê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    exit 1
fi

# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
docker-compose down

# ì´ë¯¸ì§€ ë¹Œë“œ
echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
docker-compose build

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ì²˜ìŒ ë°°í¬ì‹œì—ë§Œ)
if [ "$1" = "--init-db" ]; then
    echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
    docker-compose run --rm trading-app python setup_database.py
fi

# ì„œë¹„ìŠ¤ ì‹œì‘
echo "ğŸ¯ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
docker-compose up -d

# í—¬ìŠ¤ì²´í¬
echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘..."
sleep 10
if curl -f http://localhost:5000/health > /dev/null 2>&1; then
    echo "âœ… ë°°í¬ ì™„ë£Œ! ì„œë¹„ìŠ¤ê°€ ì •ìƒ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤."
    echo "ğŸŒ ì›¹ ì¸í„°í˜ì´ìŠ¤: http://localhost"
    echo "ğŸ“Š API ë¬¸ì„œ: http://localhost"
else
    echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:"
    docker-compose logs trading-app
    exit 1
fi

echo "ğŸ“‹ ìœ ìš©í•œ ëª…ë ¹ì–´:"
echo "  docker-compose logs -f trading-app  # ë¡œê·¸ í™•ì¸"
echo "  docker-compose restart             # ì¬ì‹œì‘"
echo "  docker-compose down               # ì„œë¹„ìŠ¤ ì¤‘ì§€"

---
# .env.example
# ë³´ì•ˆ ì„¤ì •
SECRET_KEY=generate-a-secure-random-key-here
ADMIN_PASSWORD=change-this-secure-password

# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DATABASE_PATH=/app/data/trading_data.db

# CORS ì„¤ì • (ë°°í¬ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½)
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# ì„œë²„ ì„¤ì •
FLASK_ENV=production
PORT=5000

# í•œêµ­íˆ¬ìì¦ê¶Œ API ì„¤ì •
APPKEY=your-app-key
APPSECRET=your-app-secret
ACCOUNT=your-account

---
# systemd ì„œë¹„ìŠ¤ íŒŒì¼ (Linux ì„œë²„ìš©)
# /etc/systemd/system/trading-app.service
[Unit]
Description=Trading App
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/opt/trading-app
Environment=PATH=/opt/trading-app/venv/bin
ExecStart=/opt/trading-app/venv/bin/gunicorn --config gunicorn.conf.py production_flask_server:app
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target

---
# Kubernetes ë°°í¬ íŒŒì¼ (k8s.yaml)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trading-app
  labels:
    app: trading-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: trading-app
  template:
    metadata:
      labels:
        app: trading-app
    spec:
      containers:
      - name: trading-app
        image: trading-app:latest
        ports:
        - containerPort: 5000
        env:
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: trading-secrets
              key: secret-key
        - name: DATABASE_PATH
          value: "/app/data/trading_data.db"
        - name: FLASK_ENV
          value: "production"
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: trading-data-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: trading-app-service
spec:
  selector:
    app: trading-app
  ports:
  - port: 80
    targetPort: 5000
  type: LoadBalancer

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: trading-data-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
# Heroku ë°°í¬ íŒŒì¼ (Procfile)
web: gunicorn --config gunicorn.conf.py production_flask_server:app

---
# Heroku ëŸ°íƒ€ì„ ì„¤ì • (runtime.txt)
python-3.9.18

---
# Heroku ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (deploy-heroku.sh)
#!/bin/bash

echo "ğŸš€ Heroku ë°°í¬ ì‹œì‘"

# Heroku CLI í™•ì¸
if ! command -v heroku &> /dev/null; then
    echo "âŒ Heroku CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    echo "ğŸ”— https://devcenter.heroku.com/articles/heroku-cli"
    exit 1
fi

# ì•± ì´ë¦„ ì…ë ¥
read -p "Heroku ì•± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: " APP_NAME

if [ -z "$APP_NAME" ]; then
    echo "âŒ ì•± ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
fi

# Heroku ì•± ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìŠ¤í‚µ)
heroku create $APP_NAME 2>/dev/null || echo "ğŸ“± ê¸°ì¡´ ì•± ì‚¬ìš©: $APP_NAME"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
heroku config:set -a $APP_NAME \
    SECRET_KEY=$(openssl rand -base64 32) \
    DATABASE_PATH="/app/trading_data.db" \
    FLASK_ENV="production" \
    ADMIN_PASSWORD="$(openssl rand -base64 16)"

# PostgreSQL ì• ë“œì˜¨ ì¶”ê°€ (ì„ íƒì‚¬í•­)
read -p "PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " USE_POSTGRES
if [ "$USE_POSTGRES" = "y" ]; then
    heroku addons:create heroku-postgresql:mini -a $APP_NAME
fi

# Git ì €ì¥ì†Œ ì„¤ì •
if [ ! -d ".git" ]; then
    git init
    git add .
    git commit -m "Initial commit"
fi

heroku git:remote -a $APP_NAME

# ë°°í¬
echo "ğŸš€ ë°°í¬ ì¤‘..."
git push heroku main

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
heroku run python setup_database.py -a $APP_NAME

echo "âœ… Heroku ë°°í¬ ì™„ë£Œ!"
echo "ğŸŒ ì•± URL: https://$APP_NAME.herokuapp.com"
echo "ğŸ“Š ê´€ë¦¬ íŒ¨ë„: https://$APP_NAME.herokuapp.com/dashboard"

# ë¡œê·¸ í™•ì¸
heroku logs --tail -a $APP_NAME

---
# AWS EC2 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (deploy-aws.sh)
#!/bin/bash

echo "ğŸš€ AWS EC2 ë°°í¬ ì‹œì‘"

# ì„œë²„ ì—…ë°ì´íŠ¸
sudo apt update && sudo apt upgrade -y

# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt install -y python3 python3-pip python3-venv nginx docker.io docker-compose git

# Docker ì„œë¹„ìŠ¤ ì‹œì‘
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker $USER

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /opt/trading-app
sudo chown $USER:$USER /opt/trading-app
cd /opt/trading-app

# ì½”ë“œ ë‹¤ìš´ë¡œë“œ (Git ì €ì¥ì†Œì—ì„œ)
# git clone https://github.com/yourusername/trading-app.git .

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cat > .env << EOF
SECRET_KEY=$(openssl rand -base64 32)
DATABASE_PATH=/opt/trading-app/data/trading_data.db
ALLOWED_ORIGINS=https://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
ADMIN_PASSWORD=$(openssl rand -base64 16)
FLASK_ENV=production
PORT=5000
EOF

# ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p data logs

# SSL ì¸ì¦ì„œ ì„¤ì • (Let's Encrypt)
if command -v certbot &> /dev/null; then
    echo "ğŸ” SSL ì¸ì¦ì„œ ì„¤ì • ì¤‘..."
    read -p "ë„ë©”ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”: " DOMAIN
    sudo certbot certonly --standalone -d $DOMAIN
    
    # SSL ì¸ì¦ì„œ ê²½ë¡œ ì—…ë°ì´íŠ¸
    sudo mkdir -p ssl
    sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem ssl/cert.pem
    sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem ssl/key.pem
fi

# Docker ì»¨í…Œì´ë„ˆ ì‹œì‘
docker-compose up -d

# Nginx ì„¤ì •
sudo cp nginx.conf /etc/nginx/sites-available/trading-app
sudo ln -s /etc/nginx/sites-available/trading-app /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

# ë°©í™”ë²½ ì„¤ì •
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw --force enable

echo "âœ… AWS EC2 ë°°í¬ ì™„ë£Œ!"
echo "ğŸŒ ì›¹ì‚¬ì´íŠ¸: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"

---
# ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ (monitor.sh)
#!/bin/bash

# ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸

LOG_FILE="/var/log/trading-monitor.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

check_service() {
    if docker-compose ps | grep -q "Up"; then
        log_message "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘"
        return 0
    else
        log_message "âŒ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ê°ì§€"
        return 1
    fi
}

check_disk_space() {
    DISK_USAGE=$(df /opt/trading-app | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 80 ]; then
        log_message "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ë†’ìŒ: ${DISK_USAGE}%"
        # ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ ì •ë¦¬
        find /opt/trading-app/logs -name "*.log" -mtime +7 -delete
    fi
}

check_memory() {
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    if [ $MEMORY_USAGE -gt 80 ]; then
        log_message "âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë†’ìŒ: ${MEMORY_USAGE}%"
    fi
}

restart_if_needed() {
    if ! check_service; then
        log_message "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹œë„"
        docker-compose restart
        sleep 30
        if check_service; then
            log_message "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì„±ê³µ"
        else
            log_message "âŒ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨"
            # ì•Œë¦¼ ë°œì†¡ (ì´ë©”ì¼, ìŠ¬ë™ ë“±)
        fi
    fi
}

# ë©”ì¸ ëª¨ë‹ˆí„°ë§ ë£¨í”„
log_message "ğŸš€ ëª¨ë‹ˆí„°ë§ ì‹œì‘"

while true; do
    check_service
    check_disk_space
    check_memory
    restart_if_needed
    
    # 5ë¶„ë§ˆë‹¤ ì²´í¬
    sleep 300
done

---
# Crontab ì„¤ì • ì˜ˆì‹œ (crontab -e)
# ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
0 2 * * * cd /opt/trading-app && docker-compose exec trading-app python -c "from database import TradingDatabase; TradingDatabase().backup_database()"

# ë§¤ì£¼ ì¼ìš”ì¼ì— ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
0 3 * * 0 cd /opt/trading-app && docker-compose exec trading-app python -c "from database import TradingDatabase; TradingDatabase().cleanup_old_data(90)"

# ë§¤ 5ë¶„ë§ˆë‹¤ ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬
*/5 * * * * /opt/trading-app/monitor.sh